#include <Windows.h>

#include "Sysinfo.h"

typedef BOOL (WINAPI *LPFN_ISWOW64PROCESS) (HANDLE, PBOOL); LPFN_ISWOW64PROCESS fnIsWow64Process;

WCHAR* MachineID ()
{
   HW_PROFILE_INFOW   HwProfInfo;
   if (GetCurrentHwProfileW(&HwProfInfo)) 
   {
	   WCHAR retw[260];
	   memset(retw, 0, sizeof(retw));
	   lstrcpyW(retw, HwProfInfo.szHwProfileGuid);
	   return retw;

   } else
	   return L"UNK";
}

WCHAR* WindowsBuild(void)
{
  OSVERSIONINFOEXW osvi;
  osvi.dwOSVersionInfoSize = sizeof(OSVERSIONINFOEXW);
  //http://msdn.microsoft.com/en-us/library/windows/desktop/ms724833(v=vs.85).aspx
  if ( GetVersionExW ( ( OSVERSIONINFOW * ) &osvi) 
	!= FALSE && osvi.dwPlatformId == VER_PLATFORM_WIN32_NT )
  {

    if ( osvi.wProductType == VER_NT_WORKSTATION )
    {
      //Windows 2000 - 5.0
      if(osvi.dwMajorVersion == 5 && osvi.dwMinorVersion == 0)
		  return L"50";
      //Windows XP -  5.1
      else if(osvi.dwMajorVersion == 5 && osvi.dwMinorVersion == 1)
		  return L"51";
      //Windows XP Professional x64 Edition - 5.2
      else if(osvi.dwMajorVersion == 5 && osvi.dwMinorVersion == 2)
		  return L"52";
      //Windows Vista - 6.0
      else if(osvi.dwMajorVersion == 6  && osvi.dwMinorVersion == 0)
		  return L"60";
      //Windows 7 - 6.1
      else if(osvi.dwMajorVersion == 6  && osvi.dwMinorVersion == 1)
		  return L"61";
      //Windows 8 - 6.2
      else if(osvi.dwMajorVersion == 6  && osvi.dwMinorVersion == 2)
		  return L"62";
    }
	//Windows Server based
    else if ( osvi.wProductType == VER_NT_DOMAIN_CONTROLLER 
		   || osvi.wProductType == VER_NT_SERVER)
    {

      //Windows Server 2003 - 5.2, Windows Server 2003 R2 - 5.2, Windows Home Server - 5.2
      if(osvi.dwMajorVersion == 5 && osvi.dwMinorVersion == 2)
		  return L"5200";
      //Windows Server 2008 - 6.0
      else if(osvi.dwMajorVersion == 6  && osvi.dwMinorVersion == 0)
		  return L"6000";
      //Windows Server 2008 R2 - 6.1
      else if(osvi.dwMajorVersion == 6  && osvi.dwMinorVersion == 1)
		  return L"6100";
      //Windows Server 2008 R2 - 6.1
      else if(osvi.dwMajorVersion == 6  && osvi.dwMinorVersion == 1)
		  return L"6200";
    }
	return L"00";
  }
  return L"00";
}

BOOL IsWow64Process()
{
    BOOL bIsWow64 = FALSE;
    fnIsWow64Process = (LPFN_ISWOW64PROCESS) GetProcAddress(GetModuleHandleW ( L"kernel32" ),"IsWow64Process");

    if(NULL != fnIsWow64Process) {
		if (!fnIsWow64Process(GetCurrentProcess(),&bIsWow64)) { }
	  }
    return bIsWow64;
}

BOOL HasAdminPrivileges()
{
    BOOL s_retVal = FALSE;
    HANDLE s_hToken = NULL;

    if( OpenProcessToken( GetCurrentProcess( ),TOKEN_QUERY,&s_hToken ) ) {
        TOKEN_ELEVATION s_Elevation;
        DWORD s_Size = sizeof( TOKEN_ELEVATION );
        if( GetTokenInformation( s_hToken, TokenElevation, &s_Elevation, sizeof( s_Elevation ), &s_Size ) ) {
            s_retVal = s_Elevation.TokenIsElevated;
        }
    }
    if( s_hToken ) {
        CloseHandle( s_hToken );
    }
    return s_retVal;
}